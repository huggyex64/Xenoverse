RETROMON = {
				:BULBASAUR => :BULBASAURVINTAGE,
				:CHARMANDER => :CHARMANDERVINTAGE,
				:SQUIRTLE => :SQUIRTLEVINTAGE,
				:WEEDLE => :WEEDLEVINTAGE,
				:KAKUNA=> :KAKUNAVINTAGE,
				:RATTATA=> :RATTATAVINTAGE,
				:RATICATE=> :RATICATEVINTAGE,
				:EKANS=> :EKANSVINTAGE,
				:ARBOK=> :ARBOKVINTAGE,
				:PIKACHU=> :PIKACHUVINTAGE,
				:SANDSHREW=> :SANDSHREWVINTAGE,
				:SANDSLASH=> :SANDSLASHVINTAGE,
				:VULPIX=> :VULPIXVINTAGE,
				:NINETALES=> :NINETALESVINTAGE,
				:JIGGLYPUFF=> :JIGGLYPUFFVINTAGE,
				:ZUBAT=> :ZUBATVINTAGE,
				:GOLBAT=> :GOLBATVINTAGE,
				:ODDISH=> :ODDISHVINTAGE,
				:GLOOM=> :GLOOMVINTAGE,
				:DIGLETT=> :DIGLETTVINTAGE,
				:DUGTRIO=> :DUGTRIOVINTAGE,
				:MEOWTHELDIW=> :MEOWTHVINTAGE,
				:ABRA=> :ABRAVINTAGE,
				:KADABRA=> :KADABRAVINTAGE,
				:KADABRA=> :KADABRAVINTAGE,
				:GEODUDE=> :GEODUDEVINTAGE,
				:GRAVELER=> :GRAVELERVINTAGE,
				:PONYTA=> :PONYTAVINTAGE,
				:RAPIDASH=> :RAPIDASHVINTAGE,
				:MAGNEMITE=> :MAGNEMITEVINTAGE,
				:MAGNETON=> :MAGNETONVINTAGE,
				:SEEL=> :SEELVINTAGE,
				:DEWGONG=> :DEWGONGVINTAGE,
				:GRIMER=> :GRIMERVINTAGE,
				:MUK=> :MUKVINTAGE,
				:GASTLY=> :GASTLYVINTAGE,
				:HAUNTER=> :HAUNTERVINTAGE,
				:ONIX=> :ONIXVINTAGE,
				:DROWZEE=> :DROWZEEVINTAGE,
				:KADABRA=> :KADABRAVINTAGE,
				:EXEGGCUTE=> :EXEGGCUTEVINTAGE,
				:EXEGGUTOR=> :EXEGGUTORVINTAGE,
				:CUBONE=> :CUBONEVINTAGE,
				:KOFFING=> :KOFFINGVINTAGE,
				:RHYHORN=> :RHYHORNVINTAGE,
				:CHANSEY=> :CHANSEYVINTAGE,
				:STARYU=> :STARYUVINTAGE,
				:STARMIE=> :STARMIEVINTAGE,
				:SCYTHER=> :SCYTHERVINTAGE,
				:ELECTABUZZ=> :ELECTABUZZVINTAGE,
				:TAUROS=> :TAUROSVINTAGE,
				:MAGIKARP=> :MAGIKARPVINTAGE,
				:GYARADOS=> :GYARADOSVINTAGE,
				:LAPRAS=> :LAPRASVINTAGE,
				:DITTO=> :DITTOVINTAGE,
				:EEVEE=> :EEVEEVINTAGE,
				:PORYGON=> :PORYGONVINTAGE,
				:DRATINI=> :DRATINIVINTAGE,
				:CHIKORITA=> :CHIKORITAVINTAGE,
				:CYNDAQUIL=> :CYNDAQUILVINTAGE,
				:TOTODILE=> :TOTODILEVINTAGE,
				:LEDYBA=> :LEDYBAVINTAGE,
				:LEDIAN=> :LEDIANVINTAGE,
				:CROBAT=> :CROBATVINTAGE,
				:NATU=> :NATUVINTAGE,
				:XATU=> :XATUVINTAGE,
				:MAREEP=> :MAREEPVINTAGE,
				:FLAAFFY=> :FLAAFFYVINTAGE,
				:AIPOM=> :AIPOMVINTAGE,
				:YANMA=> :YANMAVINTAGE,
				:MURKROW=> :MURKROWVINTAGE,
				:GIRAFARIG=> :GIRAFARIGVINTAGE,
				:STEELIX=> :STEELIXVINTAGE,
				:SNUBBULL=> :SNUBBULLVINTAGE,
				:SHUCKLE=> :SHUCKLEVINTAGE,
				:HERACROSS=> :HERACROSSVINTAGE,
				:SNEASEL=> :SNEASELVINTAGE,
				:TEDDIURSA=> :TEDDIURSAVINTAGE,
				:CORSOLA=> :CORSOLAVINTAGE,
				:REMORAID=> :REMORAIDVINTAGE,
				:OCTILLERY=> :OCTILLERYVINTAGE,
				:MANTINE=> :MANTINEVINTAGE,
				:HOUNDOUR=> :HOUNDOURVINTAGE,
				:SMEARGLE=> :SMEARGLEVINTAGE,
				:MILTANK=> :MILTANKVINTAGE,
				:LARVITAR=> :LARVITARVINTAGE,
				:PUPITAR=> :PUPITARVINTAGE,
				:SKARMORY=>:SKARMORYVINTAGE,
				:URSARING=>:URSARING,
				# pass 1
				:GROWLITHE=> :GROWLITHEVINTAGE,
				:ARCANINE=> :ARCANINEVINTAGE,
				:MAGBY=> :MAGBYVINTAGE,
				:MAGMAR=> :MAGMARVINTAGE,
				:HORSEA=> :HORSEAVINTAGE,
				:SEADRA=> :SEADRAVINTAGE,
				:KINGDRA=> :KINGDRAVINTAGE,
				:PSYDUCK=> :PSYDUCKVINTAGE,
				:GOLDUCK=> :GOLDUCKVINTAGE,
				:WOOPER=> :WOOPERVINTAGE,
				:QUAGSIRE=> :QUAGSIREVINTAGE,
				# pass 2
				:BELLSPROUT=>:BELLSPROUTVINTAGE,
				:WEEPINBELL=>:WEEPINBELLVINTAGE,
				:VICTREEBELL=>:VICTREEBELLVINTAGE,
				:TANGELA=>:TANGELAVINTAGE,
				:SWINUB=>:SWINUBVINTAGE,
				:PILOSWINE=>:PILOSWINEVINTAGE,
				:MISDREAVUS=>:MISDREAVUSVINTAGE,
				:GLIGAR=>:GLIGARVINTAGE,
				:FORRETRESS=>:FORRETRESSVINTAGE,
				:KANGASKHAN=>:KANGASKHANVINTAGE,
				:SUDOWOODO=>:SUDOWOODOVINTAGE,
				:PARASECT=>:PARASECTVINTAGE,
				:MRMIME=>:MRMIMEVINTAGE,
				# pass 3
				:SLOWPOKE=>:SLOWPOKEVINTAGE,
				:SLOWBRO=>:SLOWBROVINTAGE,
				:SLOWKING=>:SLOWKINGVINTAGE,
				:MARILL=>:MARILLVINTAGE,
				:AZUMARILL=>:AZUMARILLVINTAGE,
				:SNORLAX=>:SNORLAXVINTAGE,
				:AERODACTYL=>:AERODACTYLVINTAGE,
				:VENONAT=>:VENONATVINTAGE,
				:HOPPIP=>:HOPPIPVINTAGE,
}

EXCLUSIVERETROMON = {
	#MEOWSY
	38 => [1396],
	#SUNMOLA
	351 => [1431],
	#BOMSEAKER
	109 => [1434],
	119 => [1434],
	120 => [1434],
	121 => [1434],
	122 => [1434],
	123 => [1434],
	124 => [1434],
	126 => [1434],
	129 => [1434],
	252 => [1434],
	253 => [1434],
	282 => [1434],
	283 => [1434],
	284 => [1434],
	285 => [1434],
	455 => [1434],
	#TIGRETTE
	181 => [1435],
	559 => [1435],
	#WOLFMAN
	281 => [1437]
}
for k in RETROMON.keys
	RETROMON[getID(PBSpecies,k)] = getID(PBSpecies,RETROMON[k])
end


$allRetro=false


$overrideEncounters={}
RETROMONSWITCH = 950

def pbEncounter(enctype)
	echoln "triggered encounter"

	#IF map is paradiso sakura
	#then ottieni incontro dal server
	if $game_map.map_id == 615 #works only in pink path
		list = nil
		Log.i("INFO","In Pink Path! Checking for encounters...")

		# first i check whether i have an encounter list stored
		if $overrideEncounters.length>0
			for key in $overrideEncounters.keys
				if Time.now - key < 7200
					#evaluate encounter by list with key
					list = $overrideEncounters[key]
					
				end
			end

			if list.nil? #no suitable list was found, so i should request a list
				list = pbRequestEncounterList()
				$overrideEncounters[Time.now]=list
			end

		else # i need to make a web request right away to retrieve the list
			if list.nil? #no suitable list was found, so i should request a list
				list = pbRequestEncounterList()
				$overrideEncounters[Time.now]=list
			end
		end

		if !list.nil? && list.length>0
			
			Log.i("INFO","SPECIAL ENCOUNTER LIST HAD")
			#if rand(100)<50
			Log.i("INFO","SPECIAL ENCOUNTER POOL TRIGGERED")
			total = 0
			chances = []
			#getting only the valid encounters
			pool = []
			list.each do |e|
				if GAME_VERSION >= e[:minver]
					if e[:daymod]==0
						pool.push(e)
					elsif e[:daymod]==1 && PBDayNight.isDay?(pbGetTimeNow())
						pool.push(e)
					elsif e[:daymod]==2 && PBDayNight.isNight?(pbGetTimeNow())
						pool.push(e)
					end
				end
			end


			pool.each do |enc| 
				chances.push(enc[:chance])
				total+=enc[:chance]
			end
			rnd = 0
			r=rand(total)
			rnd=r if rnd<r

			chosen = 0
			chance = 0
			for i in 0...chances.length
				chance+=chances[i]
				if rnd<chance
					chosen=i
					break
				end
			end

			encountered = pool[chosen]
			if encountered != nil
				level=encountered[:minlevel]+rand(1+encountered[:maxlevel]-encountered[:minlevel])
				poke = pbGenerateWildPokemon(encountered[:species],level)
				if (encountered[:form]>0)
					poke.form = encountered[:form]
					poke.resetMoves
				end
				pbWildPokemonBattle(poke)
				return true
			end
			#end
		end
	end

  if $PokemonGlobal.partner
    encounter1=$PokemonEncounters.pbEncounteredPokemon(enctype)
    return false if !encounter1
    encounter2=$PokemonEncounters.pbEncounteredPokemon(enctype)
    return false if !encounter2
    $PokemonTemp.encounterType=enctype
    pbDoubleWildBattle(encounter1[0],encounter1[1],encounter2[0],encounter2[1])
    $PokemonTemp.encounterType=-1
    return true
  else
    encounter=$PokemonEncounters.pbEncounteredPokemon(enctype)
    return false if !encounter
    $fishing = true if enctype == EncounterTypes::OldRod || enctype ==EncounterTypes::GoodRod || enctype ==EncounterTypes::SuperRod
    $PokemonTemp.encounterType=enctype
    if $Trainer.retrochain[encounter[0]]==nil
      $Trainer.retrochain[encounter[0]]=0
    end
	ch = 1 + $Trainer.retrochain[encounter[0]]/63
	echoln encounter[0]
	echoln RETROMON[getConst(PBSpecies,encounter[0])]
	echoln ($game_switches[RETROMONSWITCH] && rand(1000)<ch) || $allRetro
	echoln "(#{$game_switches[RETROMONSWITCH]} && #{rand(1000)<ch}) #{$allRetro}"
	if (($game_switches[RETROMONSWITCH] && rand(1000)<ch) || $allRetro)
		echoln "triggered retro"
		if RETROMON[encounter[0]] != nil
			#if i'm in a special area, i want a 50/50 chance of encountering a special retromon if i would encounter a retromon
			if (EXCLUSIVERETROMON.has_key?($game_map.map_id))
				if (rand(100)>50)
					pbWildBattle(RETROMON[encounter[0]],encounter[1])
				else
					pbWildBattle(EXCLUSIVERETROMON[$game_map.map_id][0],encounter[1])
				end
			else
				pbWildBattle(RETROMON[encounter[0]],encounter[1])
			end
		elsif !RETROMON.has_key?(encounter[0]) && EXCLUSIVERETROMON.has_key?($game_map.map_id)
			#if i wouldn't find a retromon, i still check if i could encounter any exclusive
			pbWildBattle(EXCLUSIVERETROMON[$game_map.map_id][0],encounter[1])
		else
			pbWildBattle(encounter[0],encounter[1])
		end
	else
		echoln "triggered standard encounter"
		$PokemonTemp.encounterType=enctype
		pbWildBattle(encounter[0],encounter[1])
	end
	$PokemonTemp.encounterType=-1
    $fishing = false if enctype == EncounterTypes::OldRod || enctype ==EncounterTypes::GoodRod || enctype == EncounterTypes::SuperRod
    return true
  end
end

def pbBattleOnStepTaken
  if $Trainer.party.length>0
    encounterType=$PokemonEncounters.pbEncounterType
    if encounterType>=0
      if $PokemonEncounters.isEncounterPossibleHere?()	
        encounter=$PokemonEncounters.pbGenerateEncounter(encounterType)
        encounter=EncounterModifier.trigger(encounter)
        if $PokemonEncounters.pbCanEncounter?(encounter)
			if $game_map.map_id == 615 #works only in pink path
				list = nil
				Log.i("INFO","In Pink Path! Checking for encounters...")
		
				# first i check whether i have an encounter list stored
				if $overrideEncounters.length>0
					for key in $overrideEncounters.keys
						if Time.now - key < 7200
							#evaluate encounter by list with key
							list = $overrideEncounters[key]
							
						end
					end
		
					if list.nil? #no suitable list was found, so i should request a list
						list = pbRequestEncounterList()
						$overrideEncounters[Time.now]=list
					end
		
				else # i need to make a web request right away to retrieve the list
					if list.nil? #no suitable list was found, so i should request a list
						list = pbRequestEncounterList()
						$overrideEncounters[Time.now]=list
					end
				end
		
				if !list.nil? && list.length>0
					
					Log.i("INFO","SPECIAL ENCOUNTER LIST HAD")
					#if rand(100)<50
						Log.i("INFO","SPECIAL ENCOUNTER POOL TRIGGERED")
						total = 0
						chances = []
						#getting only the valid encounters
						pool = []
						list.each do |e|
							if GAME_VERSION >= e[:minver]
								if e[:daymod]==0
									pool.push(e)
								elsif e[:daymod]==1 && PBDayNight.isDay?(pbGetTimeNow())
									pool.push(e)
								elsif e[:daymod]==2 && PBDayNight.isNight?(pbGetTimeNow())
									pool.push(e)
								end
							end
						end
		
		
						pool.each do |enc| 
							chances.push(enc[:chance])
							total+=enc[:chance]
						end
						rnd = 0
						r=rand(total)
						rnd=r if rnd<r
		
						chosen = 0
						chance = 0
						for i in 0...chances.length
							chance+=chances[i]
							if rnd<chance
								chosen=i
								break
							end
						end
		
						encountered = pool[chosen]
						if encountered != nil
							level=encountered[:minlevel]+rand(1+encountered[:maxlevel]-encountered[:minlevel])
							poke = pbGenerateWildPokemon(encountered[:species],level)
							if (encountered[:form]>0)
								poke.form = encountered[:form]
								poke.resetMoves
							end
							if $Trainer.retrochain[encountered[:species]]==nil
								$Trainer.retrochain[encountered[:species]]=0
							end
							#Retromon chance
							ch = 1 + $Trainer.retrochain[encountered[:species]]/63
							if (($game_switches[RETROMONSWITCH] && rand(1000)<ch) || $allRetro)
								echoln "triggered retro"
								if RETROMON[encountered[:species]] != nil
									#if i'm in a special area, i want a 50/50 chance of encountering a special retromon if i would encounter a retromon
									if (EXCLUSIVERETROMON.has_key?($game_map.map_id))
										if (rand(100)>50)
											pbWildBattle(RETROMON[encountered[:species]],level)
										else
											pbWildBattle(EXCLUSIVERETROMON[$game_map.map_id][0],level)
										end
									else
										pbWildBattle(RETROMON[encountered[:species]],level)
									end
								elsif !RETROMON.has_key?(encountered[:species]) && EXCLUSIVERETROMON.has_key?($game_map.map_id)
									#if i wouldn't find a retromon, i still check if i could encounter any exclusive
									pbWildPokemonBattle(poke)
								end
							else
								pbWildPokemonBattle(poke)
							end
							return true
						end
					#end
				end
			end


          if $PokemonGlobal.partner
            encounter2=$PokemonEncounters.pbEncounteredPokemon(encounterType)
            if $Trainer.retrochain[encounter[0]]==nil
              $Trainer.retrochain[encounter[0]]=0
            end
            if $Trainer.retrochain[encounter[1]]==nil
              $Trainer.retrochain[encounter[1]]=0
            end
			ch = 1 + $Trainer.retrochain[encounter[0]]/63
			e1 = (($game_switches[RETROMONSWITCH] && rand(1000)<ch) || $allRetro) ? RETROMON[encounter[0]] : encounter[0]
			ch = 1 + $Trainer.retrochain[encounter[0]]/63
			e2 = (($game_switches[RETROMONSWITCH] && rand(1000)<ch) || $allRetro) ? RETROMON[encounter2[0]] : encounter[0]
			if RETROMON[encounter[0]] != nil
				pbDoubleWildBattle(e1,encounter[1],e2,encounter2[1])
			else
				pbDoubleWildBattle(encounter[0],encounter[1],encounter2[0],encounter2[1])
			end
          else
            if $Trainer.retrochain[encounter[0]]==nil
              $Trainer.retrochain[encounter[0]]=0
            end
            ch = 1 + $Trainer.retrochain[encounter[0]]/63
			echoln "encounter #{encounter[0]}"
			echoln "retro encounter #{RETROMON[encounter[0]]}"
			if (($game_switches[RETROMONSWITCH] && rand(1000)<ch) || $allRetro)
				echoln "triggered retro"
				if RETROMON[encounter[0]] != nil
					#if i'm in a special area, i want a 50/50 chance of encountering a special retromon if i would encounter a retromon
					if (EXCLUSIVERETROMON.has_key?($game_map.map_id))
						if (rand(100)>50)
							pbWildBattle(RETROMON[encounter[0]],encounter[1])
						else
							pbWildBattle(EXCLUSIVERETROMON[$game_map.map_id][0],encounter[1])
						end
					else
						pbWildBattle(RETROMON[encounter[0]],encounter[1])
					end
				elsif !RETROMON.has_key?(encounter[0]) && EXCLUSIVERETROMON.has_key?($game_map.map_id)
					#if i wouldn't find a retromon, i still check if i could encounter any exclusive
					pbWildBattle(EXCLUSIVERETROMON[$game_map.map_id][0],encounter[1])
				end
			else
				pbWildBattle(encounter[0],encounter[1])
			end
          end
        end
        EncounterModifier.triggerEncounterEnd()
      end
    end
  end
end

class PokeBattle_Trainer
	attr_accessor(:retrochain)
	
	def retrochain
		if @retrochain==nil
			@retrochain={}
		end
		return @retrochain
	end
	
end
def pbTestRetroChances
	ch = 1 + $Trainer.retrochain[PBSpecies::AIPOM]/63
	for i in 0...500
		echoln "Found [#{rand(1000)<ch}]"
		echo " Found [#{rand(1000)<ch}]"
		echo " Found [#{rand(1000)<ch}]"
	end
end

def pbTimeTest
	time = Time.now
	180.times do
		Graphics.update
		Input.update
	end
	time2 = Time.now
	dt = time2 - time
	echoln "time:#{time} time2:#{time2} dt:#{dt}"
end

def pbRequestEncounterList()
	#Getting the response from the server
	Log.i("DEBUG","Starting web request")
	res = ""
	begin
		res = Database.makeRequest("encounterList") rescue ""
		if res != ""
			result = res.split("\r\n")
			result.each_index do |encId|
				result[encId] = result[encId].split("</s>")
			end
			Log.i("DEBUG","#{result}")
			list = []

			#Handling all the parsing needed
			result.each do |enc|
				parsed = {
					:species => enc[0].to_sym,
					:minlevel => enc[1].to_i,
					:maxlevel => enc[2].to_i,
					:form => enc[3].to_i,
					:daymod => enc[4].to_i,
					:chance => enc[5].to_i,
					:minver => enc[6] == "" ? Version.new("1.0.0") : Version.new(enc[6])
				}
				list.push(parsed)
			end

			#sorting by decreasing chances
			list = list.sort {|x,y| y[:chance]<=>x[:chance]}

			Log.i("DEBUG",list)
			return list
		else
			Log.i("INFO","Failed to retrieve encounter list or was empty.")
			return []
		end
	end
end